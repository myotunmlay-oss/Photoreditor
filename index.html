<html lang="my">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Function Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ede9fe 100%);
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .main-btn {
            background-color: #7c3aed;
            transition: all 0.3s;
        }
        .main-btn:hover {
            background-color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.4);
        }
        input:focus, textarea:focus {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
        }
        .settings-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            color: #4c1d95;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .settings-btn:hover {
            color: #7c3aed;
        }
        #api-key-section {
            display: none; 
        }
        
        .prompt-history-item {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .prompt-history-item:hover {
            background-color: #eef2ff; /* Violet-50 */
        }
        .prompt-history-item .prompt-text {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .favorite-btn {
            color: #d1d5db; /* Gray-300 */
            transition: color 0.2s;
        }
        .favorite-btn.is-favorited {
            color: #fbbf24; /* Amber-400 (Star color) */
        }
        
        .tab-active {
            border-bottom: 3px solid #7c3aed;
            color: #4c1d95;
            font-weight: 700;
        }

        /* Side Panel Styles for Prompt History */
        #promptHistoryPanel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px; /* Fixed width for the side panel */
            height: 100vh;
            background-color: #ffffff;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 20;
            transform: translateX(300px); /* Initially hidden */
            transition: transform 0.3s ease-in-out;
            padding: 1.5rem;
        }

        #promptHistoryPanel.is-open {
            transform: translateX(0); /* Slide in */
        }

        .history-section {
            max-height: calc(100vh - 100px); /* Adjust based on header size */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-start justify-center">

    <div class="container-card bg-white rounded-2xl p-6 sm:p-10 w-full max-w-5xl space-y-8">
        
        <div id="settingsBtn" class="settings-btn p-1 rounded-full bg-violet-50 hover:bg-violet-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </div>
        
        <div id="historyToggleBtn" class="settings-btn p-1 rounded-full bg-violet-50 hover:bg-violet-100" style="right: 5rem;">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13M3.461 6.377l.758 1.488A1 1 0 005.131 8h13.738a1 1 0 00.912-.767l.758-1.488M12 6.253V2.5m0 3.753A6.75 6.75 0 0118.75 12c0 3.59-2.91 6.5-6.5 6.5S5.25 15.59 5.25 12A6.75 6.75 0 0112 6.253z"></path>
            </svg>
        </div>

        <h1 class="text-4xl font-extrabold text-violet-800 text-center tracking-tight pt-2">âœ¨ AI Multi-Function Studio</h1>
        <div id="status-message" class="text-center font-semibold text-sm text-green-600">âœ… á€…á€”á€…á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€…á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹</div>
        
        <div id="image-count-section" class="text-center text-sm font-medium text-gray-700 space-y-1 p-2 border-b border-gray-200">
            <p>
                <span class="font-bold text-violet-600">á€œá€…á€‰á€º á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€á€²á€·á€á€±á€¬ á€•á€¯á€¶á€¡á€›á€±á€¡á€á€½á€€á€º: </span>
                <span id="monthlyImageCount" class="text-2xl font-extrabold text-indigo-600">0</span>
                <span class="text-gray-500">(á€œá€€á€¯á€”á€ºá€œá€»á€¾á€„á€º á€¡á€œá€­á€¯á€¡á€œá€»á€±á€¬á€€á€º á€á€¯á€Šá€•á€¼á€”á€ºá€–á€¼á€…á€ºá€•á€«á€™á€Šá€ºá‹)</span>
            </p>
        </div>
        <div id="api-key-section" class="border-t border-b py-6 rounded-none space-y-4 bg-white shadow-xl p-6">
            <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                <span class="text-violet-600">ğŸ”‘</span> <span>Gemini API Key á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º</span>
            </h2>
            <label for="apiKey" class="block text-sm font-medium text-gray-700">á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€º API Key</label>
            <div class="flex space-x-3">
                <input type="password" id="apiKey" placeholder="AIzaSy..."
                       class="flex-grow p-3 border border-gray-300 rounded-xl text-gray-800 transition duration-150">
                <button id="saveKeyBtn" class="bg-indigo-600 text-white px-5 py-3 rounded-xl text-sm font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º
                </button>
            </div>
            <p id="key-status" class="text-sm text-green-600 font-medium pt-1"></p>
        </div>

        <div class="flex border-b border-gray-200 overflow-x-auto whitespace-nowrap">
            <button data-category="image_edit" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600 tab-active">
                ğŸ“· Image Editor (Single-Image)
            </button>
            <button data-category="faceswap" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600">
                ğŸ­ Faceswap (Single-Face)
            </button>
            <button data-category="multiface_swap" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600">
                ğŸ‘¥ Multi-Face Swap
            </button>
            <button data-category="image_generator" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600">
                ğŸ¨ Image Generator
            </button>
            <button data-category="family_compositor" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600">
                ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Compositor (Multi-Image)
            </button>
            <button data-category="html_create" class="category-tab px-4 py-2 text-gray-600 hover:text-violet-600">
                ğŸ’» HTML Web App Create
            </button>
        </div>

        <div id="main-app-section" class="grid grid-cols-1 lg:grid-cols-3 gap-8 transition duration-500">
            
            <div class="lg:col-span-3 space-y-8"> <div id="imageUploadSection" class="p-6 rounded-xl space-y-4 bg-white shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                        <span class="text-violet-600" id="step1Icon">1ï¸âƒ£</span> <span id="step1Title">á€•á€¯á€¶ á€á€„á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸</span>
                    </h2>
                    
                    <div id="singleImageInput" class="space-y-3">
                        <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition duration-150 cursor-pointer">
                    </div>
                    
                    <div id="faceswapInputs" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" id="targetLabel">Target Image (á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¶á€™á€Šá€·á€ºá€•á€¯á€¶)</label>
                            <input type="file" id="targetImageInput" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                        </div>
                        <div id="sourceMultiInputDiv">
                            <label class="block text-sm font-medium text-gray-700 mb-1" id="sourceLabel">Source Face Image (á€šá€°á€™á€Šá€·á€ºá€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶)</label>
                            <input type="file" id="sourceImageInput" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 cursor-pointer">
                        </div>
                    </div>
                    
                    <p id="uploadHint" class="text-xs text-gray-400">Image Editor á€¡á€á€½á€€á€º á€“á€¬á€á€ºá€•á€¯á€¶ á á€•á€¯á€¶ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€á€Šá€ºá‹</p>
                </div>
                
                <div class="p-6 rounded-xl space-y-4 bg-white shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                        <span class="text-violet-600" id="step2Icon">2ï¸âƒ£</span> <span id="step2Title">á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º</span>
                    </h2>
                    <textarea id="prompt" rows="4" placeholder="á€¥á€•á€™á€¬: á€•á€¯á€¶á€‘á€²á€€ á€€á€¬á€¸á€€á€­á€¯ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ á€”á€±á€¬á€€á€ºá€á€¶á€€á€­á€¯ á€”á€±á€á€„á€ºá€á€»á€­á€”á€ºá€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« (4K, cinematic lighting)"
                              class="w-full p-3 border border-gray-300 rounded-xl text-gray-800 transition duration-150"></textarea>
                    
                    <div class="flex space-x-3 pt-2">
                        <button id="savePromptBtn" class="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-600 transition duration-150 shadow-sm flex-grow">
                            ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º
                        </button>
                        <button id="deletePromptBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-red-600 transition duration-150 shadow-sm">
                            âŒ á€–á€»á€€á€ºá€›á€”á€º
                        </button>
                    </div>

                    <button id="generateBtn" class="main-btn w-full text-white px-4 py-4 rounded-xl text-xl font-extrabold shadow-lg mt-4">
                        ğŸ–¼ï¸ AI á€–á€¼á€„á€·á€º á€…á€á€„á€ºá€›á€”á€º
                    </button>
                </div>
            </div>

            </div>

        <div class="p-6 rounded-xl space-y-8 bg-white shadow-lg">
            
            <div id="imageResultContainer" class="grid grid-cols-1 gap-8">
                
                <div id="targetImageDisplay" class="p-4 bg-gray-50 rounded-xl shadow-inner flex flex-col image-display-section">
                    <p class="text-center font-semibold text-gray-700 mb-2" id="originalLabel">á€™á€°á€›á€„á€ºá€¸ Target á€•á€¯á€¶</p>
                    <div id="originalContainer" class="flex-grow flex items-center justify-center overflow-hidden">
                        <p id="originalMessage" class="text-gray-400 text-center p-4">á€á€„á€ºá€á€½á€„á€ºá€¸á€™á€Šá€·á€ºá€•á€¯á€¶á€á€Šá€º á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                        <img id="originalImage" class="hidden w-full h-auto max-h-[80vh] object-contain rounded-lg" alt="Original Image">

                        <div id="multiImagePreview" class="hidden w-full h-full p-2 overflow-y-auto">
                            <p class="text-gray-600 font-medium text-sm mb-2" id="multiImagePreviewTitle">á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€•á€¯á€¶á€™á€»á€¬á€¸</p>
                            <ul id="multiImageList" class="space-y-2"></ul>
                        </div>
                        </div>
                </div>

                <div id="sourceImageDisplay" class="p-4 bg-gray-50 rounded-xl shadow-inner flex-col image-display-section hidden">
                    <p class="text-center font-semibold text-gray-700 mb-2" id="sourceImageDisplayLabel">á€™á€°á€›á€„á€ºá€¸ Source á€•á€¯á€¶</p>
                    <div id="sourceContainer" class="flex-grow flex items-center justify-center overflow-hidden">
                        <p id="sourceMessage" class="text-gray-400 text-center p-4">Source Image á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                        <img id="sourceImagePreview" class="hidden w-full h-auto max-h-[80vh] object-contain rounded-lg" alt="Source Image">
                    </div>
                </div>

                <div id="generatedImageDisplay" class="p-4 bg-gray-50 rounded-xl shadow-inner flex flex-col image-display-section">
                    <p class="text-center font-semibold text-gray-700 mb-2" id="generatedLabel">á€•á€¼á€„á€ºá€•á€¼á€®á€¸á€•á€¯á€¶</p>
                    <div id="outputContainer" class="flex-grow flex items-center justify-center overflow-hidden">
                        <p id="outputMessage" class="text-gray-500 text-center p-4">á€›á€œá€’á€ºá€á€Šá€º á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                        <img id="outputImage" class="hidden w-full h-auto max-h-[80vh] object-contain rounded-lg" alt="Generated Image">
                        <pre id="codeOutput" class="hidden p-4 text-xs overflow-auto bg-gray-800 text-green-400 rounded-lg w-full h-full whitespace-pre-wrap">Generated code will appear here.</pre>
                    </div>
                </div>

            </div>
        </div>

    </div>
    
    <div id="promptHistoryPanel">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-xl font-bold text-gray-700">ğŸ“ Prompt á€™á€¾á€á€ºá€á€™á€ºá€¸</h2>
            <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="history-section space-y-4">
            <div>
                <h3 class="font-bold text-violet-600 mb-2 flex justify-between items-center">
                    â­ á€¡á€›á€±á€¸á€€á€¼á€®á€¸ Prompts (Favorites)
                    <button id="clearFavoritesBtn" class="text-xs text-red-400 hover:text-red-600 font-medium">á€¡á€¬á€¸á€œá€¯á€¶á€¸á€–á€»á€€á€º</button>
                </h3>
                <div id="favoritePromptList" class="space-y-1 p-2 rounded-lg bg-yellow-50">
                    <p class="text-gray-500 text-sm" id="favoritesEmptyMessage">Favorite á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-gray-600 mb-2 flex justify-between items-center">
                    ğŸ•°ï¸ á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€¯á€¶á€¸ Prompts
                    <button id="clearHistoryBtn" class="text-xs text-red-500 hover:text-red-700 font-medium">á€¡á€¬á€¸á€œá€¯á€¶á€¸á€–á€»á€€á€º</button>
                </h3>
                <div id="promptHistoryList" class="space-y-1 p-2 rounded-lg bg-gray-50">
                    <p class="text-gray-400 text-sm" id="historyEmptyMessage">á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        // UI Elements
        const apiKeyInput = document.getElementById('apiKey');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const keyStatus = document.getElementById('key-status');
        const mainAppSection = document.getElementById('main-app-section');
        const generateBtn = document.getElementById('generateBtn');
        const imageInput = document.getElementById('imageInput');
        const promptInput = document.getElementById('prompt');
        const outputMessage = document.getElementById('outputMessage');
        const outputImage = document.getElementById('outputImage');
        const settingsBtn = document.getElementById('settingsBtn');
        const apiKeySection = document.getElementById('api-key-section');
        const savePromptBtn = document.getElementById('savePromptBtn');
        const deletePromptBtn = document.getElementById('deletePromptBtn');
        
        // Image Count Element
        const monthlyImageCountEl = document.getElementById('monthlyImageCount');

        // History Elements
        const historyToggleBtn = document.getElementById('historyToggleBtn'); // New
        const promptHistoryPanel = document.getElementById('promptHistoryPanel'); // New
        const closeHistoryBtn = document.getElementById('closeHistoryBtn'); // New
        const clearFavoritesBtn = document.getElementById('clearFavoritesBtn'); // New
        const favoritePromptList = document.getElementById('favoritePromptList'); // New
        const favoritesEmptyMessage = document.getElementById('favoritesEmptyMessage'); // New
        
        const imageResultContainer = document.getElementById('imageResultContainer');
        const targetImageDisplay = document.getElementById('targetImageDisplay');
        const sourceImageDisplay = document.getElementById('sourceImageDisplay');

        const originalImage = document.getElementById('originalImage');
        const originalMessage = document.getElementById('originalMessage');
        const sourceImagePreview = document.getElementById('sourceImagePreview');
        const sourceMessage = document.getElementById('sourceMessage');
        const multiImagePreview = document.getElementById('multiImagePreview');
        const multiImageList = document.getElementById('multiImageList');
        const multiImagePreviewTitle = document.getElementById('multiImagePreviewTitle');
        
        const generatedLabel = document.getElementById('generatedLabel');
        const originalLabel = document.getElementById('originalLabel');
        const codeOutput = document.getElementById('codeOutput');
        
        // Category Specific Elements
        const promptHistoryList = document.getElementById('promptHistoryList');
        const historyEmptyMessage = document.getElementById('historyEmptyMessage');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const categoryTabs = document.querySelectorAll('.category-tab');
        const imageUploadSection = document.getElementById('imageUploadSection');
        const uploadHint = document.getElementById('uploadHint');
        const step1Title = document.getElementById('step1Title');
        const singleImageInput = document.getElementById('singleImageInput');
        const faceswapInputs = document.getElementById('faceswapInputs');
        const targetImageInput = document.getElementById('targetImageInput'); 
        const sourceImageInput = document.getElementById('sourceImageInput'); 
        const targetLabel = document.getElementById('targetLabel');
        const sourceLabel = document.getElementById('sourceLabel');
        const sourceMultiInputDiv = document.getElementById('sourceMultiInputDiv');

        
        let currentCategory = 'image_edit'; 
        
        // Storage Keys
        const API_KEY_STORAGE_KEY = 'gemini_api_key_local';
        const PROMPT_STORAGE_KEY = 'saved_image_prompt';
        const HISTORY_STORAGE_KEY = 'prompt_history';
        const FAVORITES_STORAGE_KEY = 'prompt_favorites'; // New Key
        const MONTHLY_IMAGE_COUNT_STORAGE_KEY = 'monthly_image_count';
        const LAST_RESET_MONTH_STORAGE_KEY = 'last_reset_month';

        // --- Image Count Management Logic ---

        function updateImageCountUI(count) {
            monthlyImageCountEl.textContent = count.toLocaleString();
        }

        function checkAndResetMonthlyCount() {
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + now.getMonth();
            const lastResetMonth = localStorage.getItem(LAST_RESET_MONTH_STORAGE_KEY);
            
            if (lastResetMonth !== currentMonth) {
                // New month detected, reset count
                localStorage.setItem(MONTHLY_IMAGE_COUNT_STORAGE_KEY, '0');
                localStorage.setItem(LAST_RESET_MONTH_STORAGE_KEY, currentMonth);
                return 0;
            }
            
            // Return current count
            return parseInt(localStorage.getItem(MONTHLY_IMAGE_COUNT_STORAGE_KEY) || '0', 10);
        }

        function incrementImageCount() {
            let currentCount = parseInt(localStorage.getItem(MONTHLY_IMAGE_COUNT_STORAGE_KEY) || '0', 10);
            currentCount++;
            localStorage.setItem(MONTHLY_IMAGE_COUNT_STORAGE_KEY, currentCount.toString());
            updateImageCountUI(currentCount);
        }

        // --- Core UI Logic ---

        function updateAppState(key) {
            if (key && key.length > 10) {
                apiKeyInput.setAttribute('disabled', 'true');
                saveKeyBtn.setAttribute('disabled', 'true');
            } else {
                apiKeyInput.removeAttribute('disabled');
                saveKeyBtn.removeAttribute('disabled');
            }
        }

        function switchCategory(category) {
            currentCategory = category;
            
            categoryTabs.forEach(tab => {
                tab.classList.toggle('tab-active', tab.dataset.category === category);
            });

            // Reset all image displays
            originalImage.classList.add('hidden');
            originalMessage.classList.remove('hidden');
            sourceImagePreview.classList.add('hidden');
            sourceMessage.classList.remove('hidden');
            outputImage.classList.add('hidden');
            outputMessage.classList.remove('hidden');
            codeOutput.classList.add('hidden');
            multiImagePreview.classList.add('hidden');
            
            // Reset Multi-select attributes
            imageInput.removeAttribute('multiple');
            sourceImageInput.removeAttribute('multiple');
            imageInput.value = '';
            targetImageInput.value = '';
            sourceImageInput.value = '';
            
            // Set image input visibility based on category
            if (category === 'faceswap') {
                singleImageInput.classList.add('hidden');
                faceswapInputs.classList.remove('hidden');
                
                // Single face swap setup
                imageResultContainer.classList.add('md:grid-cols-3');
                sourceImageDisplay.classList.remove('hidden');
                targetLabel.textContent = "Target Image (á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¶á€™á€Šá€·á€ºá€•á€¯á€¶)";
                sourceLabel.textContent = "Source Face Image (á€šá€°á€™á€Šá€·á€ºá€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶)";
                sourceMultiInputDiv.style.display = 'block';
                
            } else if (category === 'multiface_swap') { // MULTI-FACE SWAP
                singleImageInput.classList.add('hidden');
                faceswapInputs.classList.remove('hidden');
                
                // Multi face swap setup
                imageResultContainer.classList.remove('md:grid-cols-3');
                imageResultContainer.classList.add('md:grid-cols-2');
                sourceImageDisplay.classList.add('hidden');
                
                targetLabel.textContent = "Target Image (á€™á€»á€€á€ºá€”á€¾á€¬á€™á€»á€¬á€¸á€…á€½á€¬á€•á€«á€á€Šá€·á€ºá€•á€¯á€¶)";
                sourceLabel.textContent = "Source Face Images (á€šá€°á€™á€Šá€·á€ºá€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶á€™á€»á€¬á€¸)";
                sourceImageInput.setAttribute('multiple', 'true');
                sourceMultiInputDiv.style.display = 'block';
                uploadHint.innerHTML = "Target Image **á€á€…á€ºá€•á€¯á€¶** á€”á€¾á€„á€·á€º Source Images **á€™á€»á€¬á€¸á€…á€½á€¬** (á€œá€²á€œá€¾á€šá€ºá€™á€Šá€·á€º á€™á€»á€€á€ºá€”á€¾á€¬á€™á€»á€¬á€¸) á€á€„á€ºá€á€½á€„á€ºá€¸á€•á€«á‹"; // Specific hint

            } else if (category === 'family_compositor') { 
                singleImageInput.classList.remove('hidden');
                faceswapInputs.classList.add('hidden');
                imageInput.setAttribute('multiple', 'true'); 
                
                // Show 2 columns (Multi-Image List + Result)
                imageResultContainer.classList.remove('md:grid-cols-3');
                imageResultContainer.classList.add('md:grid-cols-2');
                sourceImageDisplay.classList.add('hidden');
                
            } else { // image_edit, image_generator, html_create
                singleImageInput.classList.remove('hidden');
                faceswapInputs.classList.add('hidden');
                
                // Show 1 column per item for others
                imageResultContainer.classList.remove('md:grid-cols-3');
                imageResultContainer.classList.remove('md:grid-cols-2');
                sourceImageDisplay.classList.add('hidden');
            }
            
            // Update UI texts and settings
            switch (category) {
                case 'image_edit':
                    imageUploadSection.style.display = 'block';
                    uploadHint.textContent = "á€•á€¼á€„á€ºá€†á€„á€ºá€œá€­á€¯á€á€Šá€·á€º á€“á€¬á€á€ºá€•á€¯á€¶ á á€•á€¯á€¶ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€á€Šá€ºá‹"; 
                    step1Title.textContent = "á€•á€¯á€¶ á€á€„á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸ (Single-Image)"; 
                    generatedLabel.textContent = "á€•á€¼á€„á€ºá€•á€¼á€®á€¸á€•á€¯á€¶";
                    originalLabel.textContent = "á€™á€°á€›á€„á€ºá€¸á€•á€¯á€¶ (Original)";
                    targetImageDisplay.classList.remove('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: á€•á€¯á€¶á€‘á€²á€€ á€€á€¬á€¸á€€á€­á€¯ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ á€”á€±á€¬á€€á€ºá€á€¶á€€á€­á€¯ á€”á€±á€á€„á€ºá€á€»á€­á€”á€ºá€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« (4K, cinematic lighting)";
                    generateBtn.textContent = 'ğŸ–¼ï¸ AI á€–á€¼á€„á€·á€º á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º';
                    break;
                case 'faceswap':
                    imageUploadSection.style.display = 'block';
                    uploadHint.textContent = "Target Image (á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¶á€™á€Šá€·á€ºá€•á€¯á€¶) á€”á€¾á€„á€·á€º Source Face Image (á€šá€°á€™á€Šá€·á€ºá€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶) á€”á€¾á€…á€ºá€á€¯á€œá€¯á€¶á€¸ á€á€„á€ºá€á€½á€„á€ºá€¸á€•á€«á‹";
                    step1Title.textContent = "á€•á€¯á€¶ á‚ á€•á€¯á€¶ á€á€„á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸ (Single-Face Swap)";
                    generatedLabel.textContent = "Faceswap á€›á€œá€’á€º";
                    originalLabel.textContent = "á€™á€°á€›á€„á€ºá€¸ Target á€•á€¯á€¶";
                    targetImageDisplay.classList.remove('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: Target á€•á€¯á€¶á€‘á€²á€€ á€™á€»á€€á€ºá€”á€¾á€¬á€€á€­á€¯ Source á€•á€¯á€¶á€€ á€™á€»á€€á€ºá€”á€¾á€¬á€”á€²á€· á€œá€²á€•á€«á‹";
                    generateBtn.textContent = 'ğŸ­ Faceswap á€…á€á€„á€ºá€›á€”á€º';
                    break;
                case 'multiface_swap':
                    imageUploadSection.style.display = 'block';
                    // uploadHint is handled above
                    step1Title.textContent = "á€•á€¯á€¶á€™á€»á€¬á€¸ á€á€„á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸ (Multi-Face Swap)";
                    generatedLabel.textContent = "Multi-Face Swap á€›á€œá€’á€º";
                    originalLabel.textContent = "á€™á€°á€›á€„á€ºá€¸ Target á€•á€¯á€¶";
                    targetImageDisplay.classList.remove('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: Target á€•á€¯á€¶á€›á€¾á€­ á€™á€»á€€á€ºá€”á€¾á€¬á€™á€»á€¬á€¸á€€á€­á€¯ Source á€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶á€™á€»á€¬á€¸á€–á€¼á€„á€·á€º á€¡á€…á€®á€¡á€…á€‰á€ºá€¡á€á€­á€¯á€„á€ºá€¸ (á€á€­á€¯á€·) á€™á€»á€€á€ºá€”á€¾á€¬á€€á€­á€¯ á€Šá€½á€¾á€”á€ºá€¸á€†á€­á€¯á (á€¥á€•á€™á€¬: á€˜á€šá€ºá€˜á€€á€ºá€€á€œá€°áá€™á€»á€€á€ºá€”á€¾á€¬á€€á€­á€¯ Source 1 á€–á€¼á€„á€·á€º) á€œá€²á€œá€¾á€šá€ºá€•á€«á‹";
                    generateBtn.textContent = 'ğŸ‘¥ Multi-Swap á€…á€á€„á€ºá€›á€”á€º';
                    break;
                case 'image_generator':
                    imageUploadSection.style.display = 'none';
                    generatedLabel.textContent = "á€–á€”á€ºá€á€®á€¸á€•á€¼á€®á€¸á€•á€¯á€¶";
                    originalLabel.textContent = "á€™á€°á€›á€„á€ºá€¸á€•á€¯á€¶ (á€™á€›á€¾á€­á€•á€«)";
                    targetImageDisplay.classList.remove('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: á€á€±á€¬á€„á€ºá€á€”á€ºá€¸á€€á€¼á€®á€¸á€™á€»á€¬á€¸á€›á€¾á€±á€·á€á€½á€„á€º á€›á€±á€á€²á€•á€”á€ºá€¸á€•á€¯á€™á€»á€¬á€¸á€–á€¼á€„á€·á€º á€•á€¼á€¯á€œá€¯á€•á€ºá€‘á€¬á€¸á€á€±á€¬ á€á€±á€á€ºá€™á€®á€¡á€­á€™á€ºá€á€…á€ºá€œá€¯á€¶á€¸ (Hyperrealistic, 8K)";
                    generateBtn.textContent = 'ğŸ¨ á€•á€¯á€¶ á€–á€”á€ºá€á€®á€¸á€›á€”á€º';
                    break;
                case 'family_compositor':
                    imageUploadSection.style.display = 'block';
                    uploadHint.textContent = "á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€–á€”á€ºá€á€®á€¸á€œá€­á€¯á€á€±á€¬ á€“á€«á€á€ºá€•á€¯á€¶ áá€ á€•á€¯á€¶á€¡á€‘á€­ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹";
                    generatedLabel.textContent = "á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€•á€¼á€®á€¸á€•á€¯á€¶";
                    originalLabel.textContent = "á€á€„á€ºá€á€½á€„á€ºá€¸á€‘á€¬á€¸á€á€±á€¬ á€•á€¯á€¶á€™á€»á€¬á€¸";
                    targetImageDisplay.classList.remove('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: á€•á€¯á€¶á€á€½á€±á€‘á€²á€€ á€œá€°á€á€½á€±á€€á€­á€¯ á€•á€„á€ºá€œá€šá€ºá€€á€™á€ºá€¸á€á€¼á€±á€™á€¾á€¬ á€›á€•á€ºá€”á€±á€á€²á€·á€•á€¯á€¶á€…á€¶ á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€–á€”á€ºá€á€®á€¸á€•á€±á€¸á€•á€«á‹ (4K, cinematic)";
                    generateBtn.textContent = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ á€•á€¯á€¶á€™á€»á€¬á€¸ á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€›á€”á€º';
                    break;
                case 'html_create':
                    imageUploadSection.style.display = 'none';
                    generatedLabel.textContent = "Generated Code (HTML)";
                    originalLabel.textContent = "á€™á€°á€›á€„á€ºá€¸á€•á€¯á€¶ (á€™á€›á€¾á€­á€•á€«)";
                    targetImageDisplay.classList.add('hidden');
                    promptInput.placeholder = "á€¥á€•á€™á€¬: Tailwind CSS á€á€¯á€¶á€¸á€•á€¼á€®á€¸ á€¡á€…á€­á€™á€ºá€¸á€›á€±á€¬á€„á€º á€á€œá€¯á€á€ºá€á€…á€ºá€á€¯á€•á€«á€á€²á€· Contact Form HTML á€€á€¯á€’á€ºá€›á€±á€¸á€•á€±á€¸á€•á€«á‹";
                    generateBtn.textContent = 'ğŸ’» Web App á€€á€¯á€’á€º á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€›á€”á€º';
                    break;
            }
        }

        // --- Image Preview Logic ---

        function renderFaceswapPreview() {
            if (currentCategory === 'faceswap') {
                const targetFile = targetImageInput.files[0];
                const sourceFile = sourceImageInput.files[0];
                
                if (targetFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => { originalImage.src = e.target.result; originalImage.classList.remove('hidden'); originalMessage.classList.add('hidden'); multiImagePreview.classList.add('hidden'); };
                    reader.readAsDataURL(targetFile);
                } else { originalImage.classList.add('hidden'); originalMessage.classList.remove('hidden'); }

                if (sourceFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => { sourceImagePreview.src = e.target.result; sourceImagePreview.classList.remove('hidden'); sourceMessage.classList.add('hidden'); };
                    reader.readAsDataURL(sourceFile);
                } else { sourceImagePreview.classList.add('hidden'); sourceMessage.classList.remove('hidden'); }
            } 
            else if (currentCategory === 'multiface_swap') {
                const targetFile = targetImageInput.files[0];
                const sourceFiles = sourceImageInput.files;

                // Target Image Preview
                if (targetFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        originalImage.src = e.target.result; 
                        originalImage.classList.remove('hidden'); 
                        originalMessage.classList.add('hidden');
                        multiImagePreview.classList.add('hidden');
                    };
                    reader.readAsDataURL(targetFile);
                } else { originalImage.classList.add('hidden'); originalMessage.classList.remove('hidden'); }

                // Source Multi-Image List Preview
                renderMultiImagePreview(sourceFiles, 'Source á€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶á€™á€»á€¬á€¸');
            }
        }

        function renderMultiImagePreview(files, title) {
            multiImageList.innerHTML = '';
            
            if (files.length === 0) {
                multiImagePreview.classList.add('hidden');
                originalMessage.classList.remove('hidden');
                return;
            }
            
            multiImagePreview.classList.remove('hidden');
            originalMessage.classList.add('hidden');
            originalImage.classList.add('hidden');
            multiImagePreviewTitle.textContent = title;

            const filesArray = Array.from(files).slice(0, 10);
            
            filesArray.forEach((file, index) => {
                const item = document.createElement('li');
                item.className = 'flex items-center space-x-2 p-2 bg-white rounded-lg shadow-sm';
                item.innerHTML = `<span class="text-xs font-semibold text-violet-600">${index + 1}.</span> <span class="text-sm text-gray-700 truncate">${file.name}</span> <span class="ml-auto text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</span>`;
                multiImageList.appendChild(item);
            });
        }
        
        imageInput.addEventListener('change', (event) => {
            const files = event.target.files;
            
            if (currentCategory === 'family_compositor') {
                renderMultiImagePreview(files, 'á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€•á€¯á€¶á€™á€»á€¬á€¸');
            } else {
                if (files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        originalImage.src = e.target.result;
                        originalImage.classList.remove('hidden');
                        originalMessage.classList.add('hidden');
                        multiImagePreview.classList.add('hidden');
                    };
                    reader.readAsDataURL(files[0]);
                } else {
                    originalImage.classList.add('hidden');
                    originalMessage.classList.remove('hidden');
                    multiImagePreview.classList.add('hidden');
                }
            }
        });

        targetImageInput.addEventListener('change', renderFaceswapPreview);
        sourceImageInput.addEventListener('change', renderFaceswapPreview);


        // --- API Call Logic (No major change) ---

        function base64EncodeImage(file) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        async function processSingleImage(file, prompt, apiKey, instruction) {
            // ... (Same as before)
            try {
                const imageBase64 = await base64EncodeImage(file);
                const payloadParts = [];
                
                payloadParts.push({ text: instruction + "\n\nUSER PROMPT: " + prompt });
                payloadParts.push({ inlineData: { mimeType: file.type, data: imageBase64 } });

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: payloadParts }],
                    generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    const errorMessage = result.error?.message || `API Error: ${response.status} ${response.statusText}`;
                    throw new Error(`API call failed: ${errorMessage}`);
                }
                
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    return `data:image/png;base64,${base64Data}`;
                } else {
                    return null;
                }

            } catch (error) {
                console.error(`Error processing image:`, error);
                throw error;
            }
        }

        async function generateImage() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            const prompt = promptInput.value.trim();
            const category = currentCategory;
            let isImageOutput = false;

            if (!apiKey || apiKey.length < 10) { alert("API Key á€€á€­á€¯ á€¦á€¸á€…á€½á€¬ Settings á€™á€¾á€á€†á€„á€·á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€±á€¸á€•á€«á‹"); return; }
            if (!prompt) { alert("á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹"); return; }

            // UI State Reset
            generateBtn.textContent = 'â±ï¸ AI á€–á€¼á€„á€·á€º á€•á€¼á€„á€ºá€†á€„á€ºá€”á€±á€•á€«á€á€Šá€º... (á€…á€±á€¬á€„á€·á€ºá€•á€«)';
            generateBtn.classList.add('bg-gray-400', 'pointer-events-none');
            generateBtn.classList.remove('main-btn');
            outputImage.classList.add('hidden');
            codeOutput.classList.add('hidden');
            outputMessage.classList.remove('hidden');
            outputMessage.textContent = "AI á€–á€¼á€„á€·á€º á€…á€á€„á€ºá€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€”á€±á€•á€«á€•á€¼á€®á‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹";

            savePromptToHistory(prompt, false); // Save prompt to history upon successful initiation

            // --- Generation Logic ---
            
            if (category === 'image_edit') {
                isImageOutput = true;
                const file = imageInput.files[0];
                if (!file) { alert("á€•á€¯á€¶á€á€…á€ºá€•á€¯á€¶ á€™á€›á€½á€±á€¸á€›á€á€±á€¸á€•á€«á‹"); resetGenerateButton(); return; }
                
                outputMessage.textContent = "á€•á€¯á€¶ á€•á€¼á€„á€ºá€†á€„á€ºá€”á€±á€•á€«á€á€Šá€ºá‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€«...";

                const instruction = "Modify the uploaded image based on the user's instructions. Output the final modified image.";
                
                try {
                    const resultUrl = await processSingleImage(file, prompt, apiKey, instruction);
                    
                    if (resultUrl) {
                        outputImage.src = resultUrl;
                        outputImage.classList.remove('hidden');
                        outputMessage.classList.add('hidden');
                        incrementImageCount();
                    } else {
                        outputMessage.textContent = "á€•á€¯á€¶á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹ á€á€¯á€¶á€·á€•á€¼á€”á€ºá€™á€¾á€¯ á€™á€›á€¾á€­á€•á€«á‹";
                    }
                } catch (error) {
                    outputMessage.textContent = `âŒ API á€¡á€™á€¾á€¬á€¸: ${error.message}. (API Key, Limit á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹)`;
                }
                
            } else if (category === 'faceswap') {
                isImageOutput = true;
                const targetFile = targetImageInput.files[0];
                const sourceFile = sourceImageInput.files[0];
                if (!targetFile || !sourceFile) { alert("Target á€”á€¾á€„á€·á€º Source á€•á€¯á€¶ á€”á€¾á€…á€ºá€™á€»á€­á€¯á€¸á€œá€¯á€¶á€¸ á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹"); resetGenerateButton(); return; }

                outputMessage.textContent = "Faceswap á€•á€¼á€¯á€œá€¯á€•á€ºá€”á€±á€•á€«á€á€Šá€ºá‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€«...";
                
                const imageParts = [];
                imageParts.push({ text: `Perform a face swap. The first image is the TARGET IMAGE (the body/scene to modify). The second image is the SOURCE FACE IMAGE (the face to use). User prompt provides additional details. Output only the final modified image.` });
                
                try {
                    imageParts.push({ inlineData: { mimeType: targetFile.type, data: await base64EncodeImage(targetFile) } });
                    imageParts.push({ inlineData: { mimeType: sourceFile.type, data: await base64EncodeImage(sourceFile) } });
                    imageParts.push({ text: "USER PROMPT: " + prompt });
                } catch (e) { alert("á€•á€¯á€¶á€–á€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€•á€«á€á€Šá€º: " + e.message); resetGenerateButton(); return; }

                const success = await callApiForSingleResult(imageParts, ['IMAGE'], prompt, apiKey);
                if (success) incrementImageCount();

            } else if (category === 'multiface_swap') { // Multi-Face Swap Logic
                isImageOutput = true;
                const targetFile = targetImageInput.files[0];
                const sourceFiles = sourceImageInput.files;

                if (!targetFile) { alert("Target Image (á€™á€»á€€á€ºá€”á€¾á€¬á€™á€»á€¬á€¸á€…á€½á€¬á€•á€«á€á€Šá€·á€ºá€•á€¯á€¶) á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹"); resetGenerateButton(); return; }
                if (sourceFiles.length === 0) { alert("Source Face Images (á€œá€²á€œá€¾á€šá€ºá€›á€”á€º á€™á€»á€€á€ºá€”á€¾á€¬á€•á€¯á€¶á€™á€»á€¬á€¸) á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€á€…á€ºá€•á€¯á€¶ á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹"); resetGenerateButton(); return; }
                
                outputMessage.textContent = `Target á€•á€¯á€¶á€™á€¾ á€™á€»á€€á€ºá€”á€¾á€¬á€™á€»á€¬á€¸á€€á€­á€¯ Source á€•á€¯á€¶ ${sourceFiles.length} á€•á€¯á€¶á€–á€¼á€„á€·á€º á€œá€²á€œá€¾á€šá€ºá€–á€”á€ºá€á€®á€¸á€”á€±á€•á€«á€á€Šá€ºá‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€«...`;

                const imageParts = [];
                let instruction = `Perform a multi-face swap on the first image (TARGET IMAGE). The subsequent images are the SOURCE FACE IMAGES. Swap the faces in the TARGET IMAGE with the faces in the SOURCE IMAGES. Crucially, the user prompt explicitly specifies which face from the Target Image corresponds to which Source Face Image. Use visual identifiers (like location, size, or order in the prompt) to determine the correct swap pairs. Output only the final modified image.`;

                imageParts.push({ text: instruction });

                try {
                    // 1. Add Target Image
                    imageParts.push({ inlineData: { mimeType: targetFile.type, data: await base64EncodeImage(targetFile) } });

                    // 2. Add Source Images
                    for (let i = 0; i < sourceFiles.length; i++) {
                        imageParts.push({ inlineData: { mimeType: sourceFiles[i].type, data: await base64EncodeImage(sourceFiles[i]) } });
                    }
                    imageParts.push({ text: "USER PROMPT: " + prompt });
                } catch (e) { alert("á€•á€¯á€¶á€–á€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€•á€«á€á€Šá€º: " + e.message); resetGenerateButton(); return; }

                const success = await callApiForSingleResult(imageParts, ['IMAGE'], prompt, apiKey);
                if (success) incrementImageCount();

            } else if (category === 'image_generator') {
                isImageOutput = true;
                const promptParts = [{ text: "Generate a detailed image based ONLY on the following description. Do not output text, only output the image. DESCRIPTION: " + prompt }];
                const success = await callApiForSingleResult(promptParts, ['IMAGE'], prompt, apiKey);
                if (success) incrementImageCount();
                
            } else if (category === 'family_compositor') {
                isImageOutput = true;
                const files = imageInput.files;
                if (files.length === 0) { alert("á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€›á€”á€º á€“á€«á€á€ºá€•á€¯á€¶á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€á€…á€ºá€•á€¯á€¶ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€±á€¸á€•á€«á‹"); resetGenerateButton(); return; }
                if (files.length > 10) { alert("á€“á€«á€á€ºá€•á€¯á€¶ áá€ á€•á€¯á€¶á€‘á€€á€º á€•á€­á€¯á€™á€›á€½á€±á€¸á€›á€•á€«á‹"); resetGenerateButton(); return; }

                outputMessage.textContent = `${files.length} á€•á€¯á€¶á€€á€­á€¯ á€•á€±á€«á€„á€ºá€¸á€…á€•á€º á€–á€”á€ºá€á€®á€¸á€”á€±á€•á€«á€á€Šá€ºá‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€«...`;

                const imageParts = [];
                imageParts.push({ text: `Based on the following ${files.length} images and the user's prompt, create a single, high-quality composite image. The output must be one single image (a family photo, group photo, etc.) that integrates the people/elements from the input images according to the instruction. USER PROMPT: ${prompt}` });

                try {
                    for (let i = 0; i < files.length; i++) {
                        imageParts.push({ inlineData: { mimeType: files[i].type, data: await base64EncodeImage(files[i]) } });
                    }
                } catch (e) { alert("á€•á€¯á€¶á€–á€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€•á€«á€á€Šá€º: " + e.message); resetGenerateButton(); return; }

                const success = await callApiForSingleResult(imageParts, ['IMAGE'], prompt, apiKey);
                if (success) incrementImageCount();

            } else if (category === 'html_create') {
                isImageOutput = false;
                const promptParts = [{ text: `You are an expert web developer. Based on the user's request, generate a complete, working HTML file that includes CSS (preferably Tailwind CSS) and basic structure. Do not include any explanation, only output the code block. USER REQUEST: ${prompt}` }];
                await callApiForSingleResult(promptParts, ['TEXT'], prompt, apiKey);
            }
            
            resetGenerateButton();
        }
        
        async function callApiForSingleResult(payloadParts, responseModality, prompt, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: payloadParts }],
                generationConfig: { responseModalities: responseModality },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    const errorMessage = result.error?.message || `API Error: ${response.status} ${response.statusText}`;
                    throw new Error(`API call failed: ${errorMessage}`);
                }

                if (responseModality.includes('TEXT')) {
                    const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text || "á€€á€¯á€’á€ºá€‘á€¯á€á€ºá€œá€¯á€•á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹";
                    outputMessage.classList.add('hidden');
                    codeOutput.textContent = textResponse.trim().replace(/^```(html|json)?\s*/, '').replace(/```$/, '');
                    codeOutput.classList.remove('hidden');
                    outputImage.classList.add('hidden');
                    return true;
                } else {
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        outputImage.src = `data:image/png;base64,${base64Data}`;
                        outputImage.classList.remove('hidden');
                        outputMessage.classList.add('hidden');
                        codeOutput.classList.add('hidden');
                        return true;
                    } else {
                        outputMessage.textContent = `á€•á€¯á€¶á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹`;
                        outputMessage.classList.remove('hidden');
                        outputImage.classList.add('hidden');
                        return false;
                    }
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                outputMessage.textContent = `âŒ API á€¡á€™á€¾á€¬á€¸: ${error.message}. (API Key, Limit á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹)`;
                outputMessage.classList.remove('hidden');
                return false;
            }
        }


        function resetGenerateButton() {
            let btnText = 'ğŸ–¼ï¸ AI á€–á€¼á€„á€·á€º á€…á€á€„á€ºá€›á€”á€º';
            if(currentCategory === 'faceswap') btnText = 'ğŸ­ Faceswap á€…á€á€„á€ºá€›á€”á€º';
            else if(currentCategory === 'multiface_swap') btnText = 'ğŸ‘¥ Multi-Swap á€…á€á€„á€ºá€›á€”á€º';
            else if(currentCategory === 'image_generator') btnText = 'ğŸ¨ á€•á€¯á€¶ á€–á€”á€ºá€á€®á€¸á€›á€”á€º';
            else if(currentCategory === 'family_compositor') btnText = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ á€•á€¯á€¶á€™á€»á€¬á€¸ á€•á€±á€«á€„á€ºá€¸á€…á€•á€ºá€›á€”á€º';
            else if(currentCategory === 'html_create') btnText = 'ğŸ’» Web App á€€á€¯á€’á€º á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€›á€”á€º';
            
            generateBtn.textContent = btnText;
            generateBtn.classList.remove('bg-gray-400', 'pointer-events-none');
            generateBtn.classList.add('main-btn');
        }

        // --- Auxiliary Logic (History/Key/Prompt) ---
        
        function loadApiKey() { 
             const loadedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (loadedKey) {
                apiKeyInput.value = loadedKey;
                keyStatus.textContent = "âœ… á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€‘á€¬á€¸á€á€±á€¬ API Key á€€á€­á€¯ á€á€„á€ºá€šá€°á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹";
                updateAppState(loadedKey);
                return loadedKey;
            }
            return null;
        }

        function loadPrompt() { 
            const savedPrompt = localStorage.getItem(PROMPT_STORAGE_KEY);
            if (savedPrompt) {
                promptInput.value = savedPrompt;
                promptInput.placeholder = "(á€™á€¾á€á€ºá€á€¬á€¸á€‘á€¬á€¸á€á€±á€¬ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º)";
                savePromptBtn.textContent = "ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€¡á€á€…á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º";
            }
        }

        // --- History & Favorites Logic (Updated) ---

        function getHistoryData() {
            const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            const favorites = JSON.parse(localStorage.getItem(FAVORITES_STORAGE_KEY) || '[]');
            return { history, favorites };
        }

        function savePromptToHistory(prompt, isFavorite = false) { 
            if (!prompt.trim()) return;
            
            let { history, favorites } = getHistoryData();

            // 1. Update History (keep unique, limited to 10)
            history = history.filter(item => item !== prompt);
            history.unshift(prompt);
            history = history.slice(0, 10);
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            
            // 2. Add to Favorites if requested (keep unique)
            if (isFavorite && !favorites.includes(prompt)) {
                favorites.unshift(prompt);
                localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(favorites));
            }

            renderHistory();
        }

        function toggleFavorite(prompt) {
            let { history, favorites } = getHistoryData();
            const isFavorited = favorites.includes(prompt);

            if (isFavorited) {
                // Remove from favorites
                favorites = favorites.filter(item => item !== prompt);
            } else {
                // Add to favorites (only if not already there)
                favorites.unshift(prompt);
                // Remove from history if it appears there, as we prioritize showing in favorites
                history = history.filter(item => item !== prompt);
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            }
            localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(favorites));
            renderHistory();
        }

        function createHistoryItem(prompt, isFavorite) {
            const item = document.createElement('div');
            item.className = 'prompt-history-item border-b last:border-b-0 text-sm text-gray-700';
            item.innerHTML = `
                <span class="prompt-text" title="${prompt}">${prompt}</span>
                <button class="favorite-btn ${isFavorite ? 'is-favorited' : ''}" data-prompt="${prompt}">
                    <svg class="w-5 h-5" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.049a1.5 1.5 0 012.902 0l1.396 3.844a1.5 1.5 0 001.385.992h4.048a1.5 1.5 0 01.832 2.766l-3.284 2.215a1.5 1.5 0 00-.518 1.625l1.044 4.093a1.5 1.5 0 01-2.316 1.678L12 18.23l-3.79 2.515a1.5 1.5 0 01-2.316-1.678l1.044-4.093a1.5 1.5 0 00-.518-1.625l-3.284-2.215a1.5 1.5 0 01.832-2.766h4.048a1.5 1.5 0 001.385-.992l1.396-3.844z"></path></svg>
                </button>
            `;

            // Click to load prompt
            item.querySelector('.prompt-text').addEventListener('click', () => {
                promptInput.value = prompt;
                promptInput.focus();
                // Close panel after selection
                promptHistoryPanel.classList.remove('is-open');
            });

            // Click to toggle favorite
            item.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent loading prompt
                toggleFavorite(e.currentTarget.dataset.prompt);
            });

            return item;
        }

        function renderHistory() { 
            const { history, favorites } = getHistoryData();

            // Render Favorites
            favoritePromptList.innerHTML = '';
            if (favorites.length === 0) {
                favoritesEmptyMessage.classList.remove('hidden');
                favoritePromptList.appendChild(favoritesEmptyMessage);
            } else {
                favoritesEmptyMessage.classList.add('hidden');
                favorites.forEach(prompt => {
                    favoritePromptList.appendChild(createHistoryItem(prompt, true));
                });
            }

            // Render Recent History
            promptHistoryList.innerHTML = '';
            // Filter history to exclude items already in favorites
            const filteredHistory = history.filter(prompt => !favorites.includes(prompt));

            if (filteredHistory.length === 0) {
                historyEmptyMessage.classList.remove('hidden');
                promptHistoryList.appendChild(historyEmptyMessage);
            } else {
                historyEmptyMessage.classList.add('hidden');
                filteredHistory.forEach(prompt => {
                    promptHistoryList.appendChild(createHistoryItem(prompt, false));
                });
            }
        }
        
        // Function to save API Key (simplified)
        function saveApiKey(key) {
            localStorage.setItem(API_KEY_STORAGE_KEY, key);
            keyStatus.textContent = "âœ… API Key á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹";
            apiKeySection.style.display = 'none';
            updateAppState(key);
        }

        // --- Initialization and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadPrompt();
            
            const initialCount = checkAndResetMonthlyCount();
            updateImageCountUI(initialCount);
            
            // Initial render of history and favorites
            renderHistory(); 

            switchCategory('image_edit'); 

            categoryTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchCategory(e.target.dataset.category);
                });
            });

            saveKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    saveApiKey(key);
                } else {
                    keyStatus.textContent = "API Key á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹";
                }
            });

            generateBtn.addEventListener('click', generateImage);
            
            settingsBtn.addEventListener('click', () => {
                apiKeySection.style.display = apiKeySection.style.display === 'block' ? 'none' : 'block';
                if (apiKeySection.style.display === 'block') {
                    loadApiKey();
                }
            });
            
            // History Toggle
            historyToggleBtn.addEventListener('click', () => {
                promptHistoryPanel.classList.toggle('is-open');
            });
            closeHistoryBtn.addEventListener('click', () => {
                promptHistoryPanel.classList.remove('is-open');
            });

            savePromptBtn.addEventListener('click', () => {
                const prompt = promptInput.value.trim();
                if (prompt) {
                    // Save to history and mark as favorite if user wants to keep it permanently
                    const confirmFavorite = confirm("á€’á€®á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ Prompt á€™á€¾á€á€ºá€á€™á€ºá€¸á€‘á€²á€™á€¾á€¬ á€¡á€›á€±á€¸á€€á€¼á€®á€¸ (Favorite) á€¡á€”á€±á€”á€²á€· á€™á€¾á€á€ºá€‘á€¬á€¸á€™á€œá€¬á€¸?");
                    savePromptToHistory(prompt, confirmFavorite);

                    localStorage.setItem(PROMPT_STORAGE_KEY, prompt);
                    alert("á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€™á€¾á€á€ºá€á€¬á€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹");
                    loadPrompt();
                } else {
                    alert("á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹");
                }
            });

            deletePromptBtn.addEventListener('click', () => {
                localStorage.removeItem(PROMPT_STORAGE_KEY);
                promptInput.value = "";
                promptInput.placeholder = "á€¥á€•á€™á€¬: á€•á€¯á€¶á€‘á€²á€€ á€€á€¬á€¸á€€á€­á€¯ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ á€”á€±á€¬á€€á€ºá€á€¶á€€á€­á€¯ á€”á€±á€á€„á€ºá€á€»á€­á€”á€ºá€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« (4K, cinematic lighting)";
                savePromptBtn.textContent = "ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º";
                alert("á€™á€¾á€á€ºá€á€¬á€¸á€‘á€¬á€¸á€á€±á€¬ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€–á€»á€€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹");
            });

            clearHistoryBtn.addEventListener('click', () => {
                if (confirm("á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€¯á€¶á€¸ Prompt á€™á€¾á€á€ºá€á€™á€ºá€¸á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€–á€»á€€á€ºá€›á€”á€º á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
                    localStorage.removeItem(HISTORY_STORAGE_KEY);
                    renderHistory();
                }
            });

            clearFavoritesBtn.addEventListener('click', () => {
                if (confirm("Favorite Prompts á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€–á€»á€€á€ºá€›á€”á€º á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
                    localStorage.removeItem(FAVORITES_STORAGE_KEY);
                    renderHistory();
                }
            });
        });

    </script>
</body>
</html>