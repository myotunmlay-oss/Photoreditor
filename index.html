<html lang="my">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI á€“á€¬á€á€ºá€•á€¯á€¶á€•á€¼á€„á€ºá€†á€„á€ºá€á€¼á€„á€ºá€¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ede9fe 100%);
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .main-btn {
            background-color: #7c3aed; /* Violet-600 */
            transition: all 0.3s;
        }
        .main-btn:hover {
            background-color: #6d28d9; /* Violet-700 */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.4);
        }
        input:focus, textarea:focus {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
        }
        .settings-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            color: #4c1d95;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .settings-btn:hover {
            color: #7c3aed;
        }
        #api-key-section {
            display: none;
        }
        .prompt-history-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .prompt-history-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-start justify-center">

    <div class="container-card bg-white rounded-2xl p-6 sm:p-10 w-full max-w-5xl space-y-8">
        
        <div id="settingsBtn" class="settings-btn p-1 rounded-full bg-violet-50 hover:bg-violet-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </div>

        <h1 class="text-4xl font-extrabold text-violet-800 text-center tracking-tight pt-2">âœ¨ AI á€“á€¬á€á€ºá€•á€¯á€¶ á€…á€á€°á€’á€®á€šá€­á€¯</h1>
        <div id="status-message" class="text-center font-semibold text-sm text-green-600">âœ… á€…á€”á€…á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€…á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹</div>

        <div id="api-key-section" class="border-t border-b py-6 rounded-none space-y-4 bg-white shadow-xl p-6">
            <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                <span class="text-violet-600">ğŸ”‘</span> <span>Gemini API Key á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º</span>
            </h2>
            <p class="text-sm text-red-600 font-medium" id="auth-error-message"></p>
            
            <label for="apiKey" class="block text-sm font-medium text-gray-700">
                á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€º API Key
            </label>
            <div class="flex space-x-3">
                <input type="password" id="apiKey" placeholder="AIzaSy..."
                       class="flex-grow p-3 border border-gray-300 rounded-xl text-gray-800 transition duration-150">
                <button id="saveKeyBtn" class="bg-indigo-600 text-white px-5 py-3 rounded-xl text-sm font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º
                </button>
            </div>
            <p id="key-status" class="text-sm text-green-600 font-medium pt-1"></p>
        </div>

        <div id="main-app-section" class="grid grid-cols-1 lg:grid-cols-3 gap-8 opacity-50 pointer-events-none transition duration-500">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="p-6 rounded-xl space-y-4 bg-white shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                        <span class="text-violet-600">1ï¸âƒ£</span> <span>á€•á€¯á€¶ á€á€„á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸</span>
                    </h2>
                    <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition duration-150 cursor-pointer">
                </div>
                
                <div class="p-6 rounded-xl space-y-4 bg-white shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                        <span class="text-violet-600">2ï¸âƒ£</span> <span>á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º</span>
                    </h2>
                    <textarea id="prompt" rows="4" placeholder="á€¥á€•á€™á€¬: á€•á€¯á€¶á€‘á€²á€€ á€€á€¬á€¸á€€á€­á€¯ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ á€”á€±á€¬á€€á€ºá€á€¶á€€á€­á€¯ á€”á€±á€á€„á€ºá€á€»á€­á€”á€ºá€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« (4K, cinematic lighting)"
                              class="w-full p-3 border border-gray-300 rounded-xl text-gray-800 transition duration-150"></textarea>
                    
                    <div class="flex space-x-3 pt-2">
                        <button id="savePromptBtn" class="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-600 transition duration-150 shadow-sm flex-grow">
                            ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º
                        </button>
                        <button id="deletePromptBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-red-600 transition duration-150 shadow-sm">
                            âŒ á€–á€»á€€á€ºá€›á€”á€º
                        </button>
                    </div>

                    <button id="generateBtn" class="main-btn w-full text-white px-4 py-4 rounded-xl text-xl font-extrabold shadow-lg mt-4">
                        ğŸ–¼ï¸ AI á€–á€¼á€„á€·á€º á€¡á€á€½á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€º
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 p-6 rounded-xl space-y-4 bg-white shadow-lg">
                <h2 class="text-xl font-bold text-gray-700 flex items-center justify-between">
                    <span>ğŸ“ Prompt á€™á€¾á€á€ºá€á€™á€ºá€¸</span>
                    <button id="clearHistoryBtn" class="text-xs text-red-500 hover:text-red-700 font-medium">á€¡á€¬á€¸á€œá€¯á€¶á€¸á€–á€»á€€á€º</button>
                </h2>
                <div id="promptHistoryList" class="space-y-2 max-h-96 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                    <p class="text-gray-400 text-sm" id="historyEmptyMessage">á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>
                </div>
            </div>
        </div>

        <div class="p-6 rounded-xl space-y-4 bg-white shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div class="p-2 bg-gray-50 rounded-xl shadow-inner min-h-[300px] flex flex-col">
                    <p class="text-center font-semibold text-gray-700 mb-2">á€™á€°á€›á€„á€ºá€¸á€•á€¯á€¶ (Original)</p>
                    <div id="originalContainer" class="flex-grow flex items-center justify-center overflow-hidden">
                        <p id="originalMessage" class="text-gray-400 text-center p-4">á€á€„á€ºá€á€½á€„á€ºá€¸á€™á€Šá€·á€ºá€•á€¯á€¶á€á€Šá€º á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                        <img id="originalImage" class="hidden w-full h-auto max-h-[60vh] object-contain rounded-lg" alt="Original Image">
                    </div>
                </div>

                <div class="p-2 bg-gray-50 rounded-xl shadow-inner min-h-[300px] flex flex-col">
                    <p class="text-center font-semibold text-gray-700 mb-2">á€•á€¼á€„á€ºá€•á€¼á€®á€¸á€•á€¯á€¶ (Generated)</p>
                    <div id="outputContainer" class="flex-grow flex items-center justify-center overflow-hidden">
                        <p id="outputMessage" class="text-gray-500 text-center p-4">á€›á€œá€’á€ºá€•á€¯á€¶á€á€Šá€º á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                        <img id="outputImage" class="hidden w-full h-auto max-h-[60vh] object-contain rounded-lg" alt="Generated Image">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // UI Elements
        const apiKeyInput = document.getElementById('apiKey');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const keyStatus = document.getElementById('key-status');
        const statusMessage = document.getElementById('status-message');
        const mainAppSection = document.getElementById('main-app-section');
        const generateBtn = document.getElementById('generateBtn');
        const imageInput = document.getElementById('imageInput');
        const promptInput = document.getElementById('prompt');
        const outputMessage = document.getElementById('outputMessage');
        const outputImage = document.getElementById('outputImage');
        const settingsBtn = document.getElementById('settingsBtn');
        const apiKeySection = document.getElementById('api-key-section');
        const savePromptBtn = document.getElementById('savePromptBtn');
        const deletePromptBtn = document.getElementById('deletePromptBtn');
        
        // New UI Elements for Side-by-Side
        const originalImage = document.getElementById('originalImage');
        const originalMessage = document.getElementById('originalMessage');

        // New UI Elements for History
        const promptHistoryList = document.getElementById('promptHistoryList');
        const historyEmptyMessage = document.getElementById('historyEmptyMessage');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        
        // Storage Keys
        const API_KEY_STORAGE_KEY = 'gemini_api_key_local';
        const PROMPT_STORAGE_KEY = 'saved_image_prompt';
        const HISTORY_STORAGE_KEY = 'prompt_history'; // New storage key

        // --- API Key Logic (Local Storage) ---
        
        function saveApiKey(key) {
            const trimmedKey = key.trim();
            if (trimmedKey) {
                localStorage.setItem(API_KEY_STORAGE_KEY, trimmedKey); 
                keyStatus.textContent = "âœ… API Key á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹";
                updateAppState(trimmedKey);
                setTimeout(() => {
                    apiKeySection.style.display = 'none';
                }, 1000);
            }
        }

        function loadApiKey() {
            const loadedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (loadedKey) {
                apiKeyInput.value = loadedKey;
                keyStatus.textContent = "âœ… á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€‘á€¬á€¸á€á€±á€¬ API Key á€€á€­á€¯ á€á€„á€ºá€šá€°á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹";
                updateAppState(loadedKey);
                return loadedKey;
            }
            // Initially ensure key section is hidden unless app is disabled
            apiKeySection.style.display = 'none';
            return null;
        }

        function updateAppState(key) {
            if (key && key.length > 10) {
                mainAppSection.classList.remove('opacity-50', 'pointer-events-none');
                apiKeyInput.setAttribute('disabled', 'true');
                saveKeyBtn.setAttribute('disabled', 'true');
            } else {
                mainAppSection.classList.add('opacity-50', 'pointer-events-none');
                apiKeyInput.removeAttribute('disabled');
                saveKeyBtn.removeAttribute('disabled');
            }
        }

        // --- Prompt Save/Load Logic ---

        function loadPrompt() {
            const savedPrompt = localStorage.getItem(PROMPT_STORAGE_KEY);
            if (savedPrompt) {
                promptInput.value = savedPrompt;
                promptInput.placeholder = "(á€™á€¾á€á€ºá€á€¬á€¸á€‘á€¬á€¸á€á€±á€¬ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º)";
                savePromptBtn.textContent = "ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€¡á€á€…á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º";
            }
        }

        savePromptBtn.addEventListener('click', () => {
            const prompt = promptInput.value.trim();
            if (prompt) {
                localStorage.setItem(PROMPT_STORAGE_KEY, prompt);
                alert("á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€™á€¾á€á€ºá€á€¬á€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹");
                loadPrompt();
            } else {
                alert("á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹");
            }
        });

        deletePromptBtn.addEventListener('click', () => {
            localStorage.removeItem(PROMPT_STORAGE_KEY);
            promptInput.value = "";
            promptInput.placeholder = "á€¥á€•á€™á€¬: á€•á€¯á€¶á€‘á€²á€€ á€€á€¬á€¸á€€á€­á€¯ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ á€”á€±á€¬á€€á€ºá€á€¶á€€á€­á€¯ á€”á€±á€á€„á€ºá€á€»á€­á€”á€ºá€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« (4K, cinematic lighting)";
            savePromptBtn.textContent = "ğŸ’¾ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€™á€¾á€á€ºá€á€¬á€¸á€›á€”á€º";
            alert("á€™á€¾á€á€ºá€á€¬á€¸á€‘á€¬á€¸á€á€±á€¬ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€–á€»á€€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹");
        });

        // --- History Logic (New) ---

        function savePromptToHistory(prompt) {
            if (!prompt.trim()) return;

            let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            
            // Prevent duplicates and keep it clean
            history = history.filter(item => item !== prompt);
            
            // Add new prompt to the top
            history.unshift(prompt);
            
            // Limit history size (e.g., to 10 items)
            history = history.slice(0, 10);

            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            promptHistoryList.innerHTML = '';
            
            if (history.length === 0) {
                historyEmptyMessage.classList.remove('hidden');
                promptHistoryList.appendChild(historyEmptyMessage);
                return;
            }
            historyEmptyMessage.classList.add('hidden');

            history.forEach((prompt, index) => {
                const item = document.createElement('div');
                item.className = 'prompt-history-item p-2 border-b last:border-b-0 text-sm text-gray-700 truncate';
                item.textContent = prompt;
                item.title = prompt; // Tooltip for full text
                item.addEventListener('click', () => {
                    // Sync System: Click to load prompt
                    promptInput.value = prompt;
                    promptInput.focus();
                    // Optionally scroll back to the top of the app section for better UX
                    window.scrollTo({ top: mainAppSection.offsetTop, behavior: 'smooth' });
                });
                promptHistoryList.appendChild(item);
            });
        }
        
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm("Prompt á€™á€¾á€á€ºá€á€™á€ºá€¸á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€–á€»á€€á€ºá€›á€”á€º á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                renderHistory();
            }
        });

        // --- Image Preview Logic (New) ---

        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                    originalImage.classList.remove('hidden');
                    originalMessage.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                originalImage.classList.add('hidden');
                originalMessage.classList.remove('hidden');
            }
        });

        // --- API Call Logic ---

        function base64EncodeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        async function generateImage() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            const prompt = promptInput.value.trim();
            const file = imageInput.files[0];

            if (!apiKey || apiKey.length < 10) {
                alert("API Key á€€á€­á€¯ á€¦á€¸á€…á€½á€¬ Settings á€™á€¾á€á€†á€„á€·á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€±á€¸á€•á€«á‹");
                return;
            }
            if (!file) {
                alert("á€•á€¯á€¶á€á€…á€ºá€•á€¯á€¶á€€á€­á€¯ á€á€„á€ºá€á€½á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹");
                return;
            }
            if (!prompt) {
                alert("á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹");
                return;
            }

            let base64Image;
            try {
                // UI state update
                generateBtn.textContent = 'â±ï¸ AI á€–á€¼á€„á€·á€º á€•á€¼á€„á€ºá€†á€„á€ºá€”á€±á€•á€«á€á€Šá€º... (á€…á€±á€¬á€„á€·á€ºá€•á€«)';
                generateBtn.classList.add('bg-gray-400', 'pointer-events-none');
                generateBtn.classList.remove('main-btn');
                
                outputMessage.textContent = "AI á€–á€¼á€„á€·á€º á€•á€¯á€¶á€•á€¼á€„á€ºá€†á€„á€ºá€™á€¾á€¯ á€…á€á€„á€ºá€”á€±á€•á€«á€•á€¼á€®á‹ á€á€á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€•á€±á€¸á€•á€«á‹";
                outputImage.classList.add('hidden');
                outputMessage.classList.remove('hidden');

                base64Image = await base64EncodeImage(file);
            } catch (e) {
                alert("á€•á€¯á€¶á€€á€­á€¯ á€–á€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€•á€«á€á€Šá€º: " + e.message);
                resetGenerateButton();
                return;
            }

            // Save prompt to history upon successful initiation
            savePromptToHistory(prompt); 

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [
                    {
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };
            
            const MAX_RETRIES = 5;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        const errorMessage = result.error?.message || `API Error: ${response.status} ${response.statusText}`;
                        throw new Error(`API call failed: ${errorMessage}`);
                    }

                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        outputImage.src = imageUrl;
                        outputImage.classList.remove('hidden');
                        outputMessage.classList.add('hidden');
                        outputMessage.textContent = "";
                        break;

                    } else {
                        const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text || "á€•á€¯á€¶á€‘á€¯á€á€ºá€œá€¯á€•á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹";
                        outputMessage.textContent = `AI áá€á€¯á€¶á€·á€•á€¼á€”á€ºá€™á€¾á€¯: ${textResponse}. á€•á€¯á€¶á€™á€‘á€½á€€á€ºá€•á€«á‹ á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€€á€­á€¯ á€•á€¼á€”á€ºá€…á€…á€ºá€•á€«á‹`;
                        outputMessage.classList.remove('hidden');
                        outputImage.classList.add('hidden');
                        break;
                    }

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        outputMessage.textContent = `âŒ API á€¡á€™á€¾á€¬á€¸: ${error.message}. (API Key á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Limit á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹)`;
                        outputMessage.classList.remove('hidden');
                        outputImage.classList.add('hidden');
                    }
                }
            }
            
            resetGenerateButton();
        }

        function resetGenerateButton() {
            generateBtn.textContent = 'ğŸ–¼ï¸ AI á€–á€¼á€„á€·á€º á€¡á€á€½á€„á€ºá€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€º';
            generateBtn.classList.remove('bg-gray-400', 'pointer-events-none');
            generateBtn.classList.add('main-btn');
        }

        // --- Initialization and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadPrompt();
            renderHistory(); // Load and render history on startup

            saveKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    saveApiKey(key);
                } else {
                    keyStatus.textContent = "API Key á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹";
                }
            });

            generateBtn.addEventListener('click', generateImage);
            
            settingsBtn.addEventListener('click', () => {
                apiKeySection.style.display = apiKeySection.style.display === 'block' ? 'none' : 'block';
                if (apiKeySection.style.display === 'block') {
                    loadApiKey();
                }
            });
        });

    </script>
</body>
</html>